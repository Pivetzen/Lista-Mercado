<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lista de Supermercado Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <style>
        .item-selected { border-color: #2563eb; background-color: #eff6ff; }
        .sticky-search { position: sticky; top: 64px; z-index: 15; }
    </style>
</head>
<body class="bg-gray-50 pb-32">

    <header class="bg-white border-b sticky top-0 z-20 p-4 shadow-sm">
        <div class="max-w-4xl mx-auto flex justify-between items-center">
            <h1 class="text-xl font-black text-gray-800 tracking-tight">SHOPLIST.IO</h1>
            <span id="contador" class="bg-blue-100 text-blue-700 text-xs font-bold px-2.5 py-0.5 rounded-full">0 itens</span>
        </div>
    </header>

    <div class="bg-gray-50 p-4 sticky-search border-b">
        <div class="max-w-4xl mx-auto">
            <input type="text" id="inputBusca" oninput="filtrarProdutos()" 
                placeholder="üîç Pesquisar item..." 
                class="w-full p-3 rounded-xl border border-gray-200 shadow-sm focus:ring-2 focus:ring-blue-500 outline-none transition">
        </div>
    </div>

    <main class="max-w-4xl mx-auto p-4 space-y-8">
        <section>
            <h2 class="text-sm font-bold text-gray-400 uppercase mb-4">Cat√°logo de Produtos</h2>
            <div id="catalogo" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3">
                </div>
        </section>

        <section id="sessao-compras" class="hidden border-t pt-8">
            <h2 class="text-sm font-bold text-gray-400 uppercase mb-4">Sua Lista para Preencher</h2>
            <div id="lista-ativa" class="space-y-3">
                </div>
        </section>
    </main>

    <footer class="fixed bottom-0 left-0 right-0 bg-white border-t p-4 z-30 shadow-2xl">
        <div class="max-w-4xl mx-auto flex items-center justify-between">
            <div>
                <p class="text-gray-400 text-xs uppercase font-bold">Total da Compra</p>
                <p id="total-geral" class="text-3xl font-black text-blue-600">R$ 0,00</p>
            </div>
            <button onclick="gerarPDF()" class="bg-gray-900 text-white px-6 py-3 rounded-xl font-bold hover:bg-black transition">
                Gerar Lista
            </button>
        </div>
    </footer>

    <script>
        const LINK_PLANILHA = "SUA_URL_AQUI"; // Cole seu link CSV aqui

        let produtosBase = [];
        let carrinho = [];

        async function carregarPlanilha() {
            try {
                const res = await fetch(LINK_PLANILHA);
                const csv = await res.text();
                const linhas = csv.split('\n').slice(1);
                
                produtosBase = linhas.map((linha, i) => {
                    const colunas = linha.split(',');
                    return {
                        id: i,
                        foto: colunas[0]?.trim() || 'https://via.placeholder.com/150',
                        nome: colunas[1]?.trim() || 'Produto sem nome'
                    };
                });
                renderizarCatalogo(produtosBase);
            } catch (e) { console.error("Erro ao carregar"); }
        }

        function renderizarCatalogo(lista) {
            const container = document.getElementById('catalogo');
            container.innerHTML = lista.map(p => {
                const estaNoCarrinho = carrinho.some(item => item.id === p.id);
                return `
                <div onclick="toggleItem(${p.id})" id="card-${p.id}" 
                    class="bg-white border rounded-xl p-2 cursor-pointer transition hover:shadow-md ${estaNoCarrinho ? 'item-selected' : ''}">
                    <img src="${p.foto}" class="w-full h-24 object-contain rounded-lg mb-2">
                    <p class="text-xs font-bold text-center text-gray-700 truncate">${p.nome}</p>
                </div>
            `}).join('');
        }

        function filtrarProdutos() {
            const termo = document.getElementById('inputBusca').value.toLowerCase();
            const filtrados = produtosBase.filter(p => 
                p.nome.toLowerCase().includes(termo)
            );
            renderizarCatalogo(filtrados);
        }

        function toggleItem(id) {
            const idx = carrinho.findIndex(item => item.id === id);
            if (idx > -1) {
                carrinho.splice(idx, 1);
            } else {
                const p = produtosBase.find(item => item.id === id);
                carrinho.push({ ...p, qtd: 1, preco: 0 });
            }
            
            document.getElementById('contador').innerText = `${carrinho.length} itens`;
            filtrarProdutos(); // Re-renderiza o cat√°logo mantendo o filtro
            atualizarListaTrabalho();
        }

        function atualizarListaTrabalho() {
            const container = document.getElementById('lista-ativa');
            const sessao = document.getElementById('sessao-compras');
            
            if(carrinho.length === 0) { sessao.classList.add('hidden'); return; }
            sessao.classList.remove('hidden');

            container.innerHTML = carrinho.map((item, i) => `
                <div class="bg-white border rounded-xl p-4 flex items-center gap-4">
                    <img src="${item.foto}" class="w-12 h-12 object-cover rounded">
                    <div class="flex-1 min-w-0">
                        <p class="font-bold text-gray-800 truncate">${item.nome}</p>
                        <div class="flex gap-2 mt-2">
                            <input type="number" value="${item.qtd}" oninput="updateVal(${i}, 'qtd', this.value)" 
                                class="w-16 border rounded-lg p-1 text-sm text-center" placeholder="Qt">
                            <input type="number" step="0.01" oninput="updateVal(${i}, 'preco', this.value)" 
                                class="w-24 border rounded-lg p-1 text-sm text-right" placeholder="R$">
                        </div>
                    </div>
                    <div class="text-right">
                        <p class="font-black text-gray-900">R$ ${(item.qtd * item.preco).toFixed(2)}</p>
                    </div>
                </div>
            `).join('');
            calcTotal();
        }

        function updateVal(i, key, val) {
            carrinho[i][key] = parseFloat(val) || 0;
            calcTotal();
            const subtotalText = document.querySelectorAll('#lista-ativa div .font-black')[i];
            subtotalText.innerText = `R$ ${(carrinho[i].qtd * carrinho[i].preco).toFixed(2)}`;
        }

        function calcTotal() {
            const t = carrinho.reduce((acc, i) => acc + (i.qtd * i.preco), 0);
            document.getElementById('total-geral').innerText = `R$ ${t.toFixed(2)}`;
        }

        function gerarPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Resumo de Compras", 14, 20);
            const rows = carrinho.map(i => [i.nome, i.qtd, `R$ ${i.preco.toFixed(2)}`, `R$ ${(i.qtd * i.preco).toFixed(2)}`]);
            doc.autoTable({
                head: [['Produto', 'Qtd', 'Unit√°rio', 'Total']],
                body: rows,
                startY: 30,
                headStyles: { fillColor: [31, 41, 55] }
            });
            doc.save("lista.pdf");
        }

        carregarPlanilha();
    </script>
</body>
</html>
